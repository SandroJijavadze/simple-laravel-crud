<?php
//echo '<!DOCTYPE html><html>';
//if (!isset($_GET['from'])){
//	$from_dest = $_GET["from"];
//	echo '<form action=\'/\' method=\'get\'><input name=\'from\' type=\'hidden\' value=\'batumi\'><input type=\'submit\' value=\'Batumi-Tbilisi\'/></form>';
//	echo '<form action=\'/\' method=\'get\'><input name=\'from\' type=\'hidden\' value=\'tbilisi\'><input type=\'submit\' value=\'Tbilisi-Batumi\'/></form>';
//	echo '<html>';
//	return;
//}
namespace App\Libraries\Trains;
require_once __DIR__ .'/vendor/autoload.php';
use GuzzleHttp\Client;
use Sunra\PhpSimple\HtmlDomParser;
class Trains{
	public  $client;
	public  $dt;
	public function __construct(){
		$this->client = new Client();
		$this->dt = (new \DateTime(date("Y-m-d")))->modify('-1 day');
	}
	public	$batumi = array('name' => 'ბათუმი', 'number' => '57151');
	public	$tbilisi = array('name' => 'თბილისი-სამგზ', 'number' => '56014');
	
	//$date -> string d/m/Y 
	function getResponse($from, $to, $date, $client){
		$res = $client->request('POST', 'https://biletebi.ge/startup.aspx?ajax=1&action=searchfortrain', [
			'form_params' => [
				'date' => $date,
				'from' => $from['number'],
				'fromStation' => $from['name'],
				'oneComp' => 'false',
				'to' => $to['number'],
				'toStation' => $to['name'],
			]
		]);
	
		return $res->getBody();
	}
	public function printTrains($from_dest){
		$from = "";
		if ($from_dest == "batumi"){
			$from = $this->batumi;
		} else {
			$from = $this->tbilisi;
		}	
		for($i = 0; $i < 7; $i++){
			$body = $this->getResponse($this->tbilisi, $this->batumi, $this->dt->modify('+1 day')->format('d/m/Y'), $this->client);
			preg_match('/<b>[0-9]{2}:[0-9]{2}<\/b>.+/', $body , $matches, PREG_OFFSET_CAPTURE);
			$html = HtmlDomParser::str_get_html($body);
		
			for($a = 0; $a < 15; $a++){
				$div = $html->find('div[class=trainDates]', $a);
				if($div === NULL){
					break;
				}
				//var_dump($divs);
				echo $div.'<br>';
			}
		}
	}
}
?>
